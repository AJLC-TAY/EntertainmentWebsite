<!DOCTYPE html>
<html lang="en">
	<head>
		<title> Javascript Test </title>

		<link rel="icon" type="image/png" 
      			href="http://localhost/res/up_arrow.png">
	</head>

	<style type="text/css">
		* {
			width: 100%;
			font-family: Montserrat, serif;
		}

		.head {
			background-color: black;
			display: flex;
			align-items: center;
			padding: 0 20px;
		}

		#search-btn {
			width: 60px;
			height: 20px;
		}

		#song-list {
			border: 2px solid black;
		}

		div h2 {
			color: white;
		}

		.video-con {
			display: flex;
			margin: 5px auto;
		}

		.song-img-con {
			width: 300px;
			height: 220px;
		}

	</style>

	<body>
		<header>
			<h1>Javascript test with Web API</h1>
		</header>

		<main>
			<section>
				<div class="head">
					<h2>List of Songs</h2>
					<input id='search-fld' style="margin: 10px auto;">
					<button id="search-btn">Search</button>
				</div>
		
				<ul id="song-list">
					<br>
					
				</ul>
			</section>

			<section>
				<div class="head">
					<h2>Artists</h2>
				</div>
		
				<ul id="artist-list">
					<br>
				</ul>
			</section>
			
		</main>

		<hr>

		<footer>
			<p><small>Copyright 2020. Alpha Group. All rights reserved.</small></p>
		</footer>


		<script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
		<script type="text/Javascript">

			const APIController = (function () {
				window.onload = loadClientAPI;
				const API_KEY = 'AIzaSyBmbwKSePliPBSyHyeA6BRuoxgfLES4YeQ';
				const CLIENT_ID = '471584331255-p66pq86kuef1ocv3jcectp3t9kb1f9bl.apps.googleusercontent.com';
				const BIGHIT_CHANNELID = 'UC3IZKseVpdzPSBaWxBxundA';
				const MAX_RESULTS = '10';


				//private methods

				//loads the Youtube API
				function loadClientAPI() {
					gapi.client.setApiKey(API_KEY);
					gapi.client.load("https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest")
				      .then(function() { console.log("GAPI client loaded for API"); },
				            function(err) { console.error("Error loading GAPI client for API", err); });
				    gapi.client.init({'clientId': CLIENT_ID});
				}

				// gets the artists data
				const _fetchArtistData = async () => {
					const result = await fetch('http://localhost/res/Artists.txt');
					return await result.json();
				}


				const _fetchSongs = async (keyword) => {
		    		var response = await gapi.client.youtube.search.list({
		      				"part": "snippet",
		      				"channelId": BIGHIT_CHANNELID,
		      				"maxResults": MAX_RESULTS,
		      				"q": keyword,
		      				"type": "video"
	    				});
					return response.result.items;
				}

				// use of closures to access the private methods
				return {

					// public method
					fetchArtistData() {
						return _fetchArtistData();
					},

					fetchSongs(keyword) {
						return _fetchSongs(keyword);
					}
				}

			})();

			const UIController = (function() {
				const DOMElements = {
					songList: '#song-list',
					artistList: '#artist-list',
					searchField: '#search-fld',
					searchButton: '#search-btn'
				}

				return {

					inputOutputFields() {
						return {
							songList: document.querySelector(DOMElements.songList),
							artistList: document.querySelector(DOMElements.artistList),
							searchField: document.querySelector(DOMElements.searchField),
							searchButton: document.querySelector(DOMElements.searchButton)
						} 
					},

					createArtistDetail(artist) {
						const html =
						`
						<div class="artist">
							<h3>${artist.name}</h3>
							<p>
								Debut Year: ${artist.debutYear}<br>
								No of Artists: ${artist.memberNo}
							</p>
						</div>`
						document.querySelector(DOMElements.artistList).insertAdjacentHTML('beforeend', html);
					},

					createSongDetail(song) {
						let title = song.snippet.title;
						let published = song.snippet.publishedAt;
						let videoID = song.id.videoId;
						let img = song.snippet.thumbnails.high;
						let html =
								`
								<div class="video-con">
									<div class="song-img-con">
										<img src="${img.url}" id="imgContainer" alt="Music video" title="${title}" style="width: 100%; height=auto">
									</div>

									<div>
										<h4>${title}</h4>
										<p> Artist name: <br>
										<small>${published}</small><br>
										<i>${videoID}</i></p>
									</div>
								</div>
								`;

						document.querySelector(DOMElements.songList).insertAdjacentHTML('beforeend', html);
					},

					clearSongList() {
						this.inputOutputFields().songList.innerHTML = `<br>`;
					}
				}
			})();


			const APPController = (function (UICtrl, APICtrl) {
				const DOMElements = UICtrl.inputOutputFields();

				const loadArtists = async () => {
					const artists = await APICtrl.fetchArtistData();
					artists.forEach(artist => UICtrl.createArtistDetail(artist));
				}


				DOMElements.searchButton.addEventListener('click', async (e) => {
					//prevent page reset
					e.preventDefault();


					UICtrl.clearSongList();

					const keyword = DOMElements.searchField.value;

					const songs = await APICtrl.fetchSongs(keyword);
					songs.forEach(song => UICtrl.createSongDetail(song));
				});

				return {
       				init() {
            			console.log('App is starting');
           				loadArtists();
        			}
    			}
			})(UIController, APIController);
			

			APPController.init();
			

			/*

			old version

			//fetches the Data of the Artists
			function fetchArtistData() {
				fetch('http://localhost/res/Artists.txt')
				.then(function (response) {
					return response.text();
				})
				.then(function(data) {
					items = JSON.parse(data);
					var artist = new Object();
					createArtistList();

					var artistList = document.getElementById('artist-list');
					for (i = 0; i < listArtist.length; i++) {
						var artistItem = listArtist[i];
						var artistListItem = document.createElement("li");
						var html = 
						`
						<div class="artist">
							<h3>${artistItem.artistName}</h3>
							<p>
								Debut Year: ${artistItem.debutYear}<br>
								No of Artists: ${artistItem.artistNo}
							</p>
						</div>`

						artistList.insertAdjacentHTML('beforeend', html);
					}

				});
				
			}


			// creates an array of Artist objects
			function createArtistList() {
				listArtist = new Array();

				for (i = 0; i < items.length; i++) {
					artist = new Object();
					artist.artistName = items[i].name;
					artist.debutYear = items[i].debutYear;
					artist.artistNo = items[i].memberNo;

					listArtist[i]=artist;
				}
			
			}

			function searchYoutube() {
		  		let keyword = document.getElementById('search-fld').value;
		   		var request = gapi.client.youtube.search.list({
		      		"part": "snippet",
		      		"channelId": BIGHIT_CHANNELID,
		      		"maxResults": 5,
		      		"q": keyword,
		      		"type": "video"
		    		});

	    		request.execute(function(response) {
	        		let results = response.result.items;
	        		for (var i = 0; i < results.length; i++) {
		        		var item = results[i];
		        		var title = item.snippet.title;
		        		var published = item.snippet.publishedAt;
		        		var videoID = item.id.videoId;
		        		var img = item.snippet.thumbnails.default;
		     			displaySearchedSongs(title, published, videoID, img);

		     		}
	   		 	});
    		}

    		function displaySearchedSongs(title, published, videoID, img) {
				var html = 
	          		`
	           		<div class="video-con">
	          		  	<img src="${img.url}" id="imgContainer" style="width: ${img.width}px; height=${img.height}px">
	           		 	 	<div>
	                			<h4>${title}</h4>
	                	 		<p><small>${published}</small></p>
	        		       	 	<p><i>${videoID}</i></p>
	            			</div>
			   		</div>
	    		    `

	           	document.getElementById('song-list').insertAdjacentHTML('beforeend', html);
    		}

    		*/
		</script>
	</body>
</html>